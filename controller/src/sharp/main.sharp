mod main;

import (
    std.io.*,
    platform,
    common.*,
    ui.support
)

tman : thread_manager;

def main(args: string[])
{
   load_library("bin/dragonfly");
   network.setup();
   constants.NETWORK_STATE = constants.SERVER;
   tman = new thread_manager(thread.current());
   tman.start_threads();
   
   common.gpio#setup();
   setup_conn_tracker();
   setup_button_manager();

   on_button_pressed.observe_on({ observer, state ->
      println("button state: $state");
   }, tman.main);

   coroutine.builder()
     .with_host(tman.net)
     .schedule(3000)
        = { ->
         network.handshake();
         disconnected = false;
      };
      
   coroutine.builder()
     .with_host(tman.net)
    .schedule(constants.INITIAL_START_DELAY)
      = { ->
         while(true) {
            if(!disconnected) {
               network.change_mode(constants.strings.FLIGHT_MODE_NORM);
            }

            delay(constants.DEVICE_UPDATE_INTERVAL);
         }
         // TODO: add controller state checks here
      };

   window.start_ui();
}
